---
title: "Triad Selection"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
```

```{r import step 3,echo=FALSE}
methyl_step2 <- read.csv("/Users/timvigers/Documents/GitHub/MS-Thesis/candidate_selection/step_2/methyl_adj.csv",stringsAsFactors = F)
methyl_step2$p.adj <- format(methyl_step2$p.value,digits = 3)
```

## Step 1: Metabolite - Methylation

For this step I ran linear models (adjusted and unadjusted) with methylation as the outcome and metabolites as the predictor. Adjusted models also included age and sex as covariates. In order to narrow down the number of models, I only looked at the metabolites that have come up repeatedly in Liz's analyses. 

### GC-TOF Candidates

```{r echo=FALSE}
candidates <- read.csv("/Users/timvigers/Documents/GitHub/MS-Thesis/data/metabolomics/liz_candidates.csv",stringsAsFactors = F)
gctof_candidates <- unique(candidates$gctof)
gctof_candidates <- gctof_candidates[order(as.numeric(sub(".*_","",gctof_candidates)))]
kable(gctof_candidates,row.names = F,col.names = "")
```

### Adjusted Model

```{r eval=FALSE}
lm(cg00000029 ~ sex + age + gctof_89, data = data)
```

#### Plots

```{r gctof adj import,echo=FALSE,cache=TRUE}
gctof <- read.csv("/Users/timvigers/Documents/GitHub/MS-Thesis/candidate_selection/step_1/sv/gctof_SV_adj.csv",stringsAsFactors = F)
gctof <- gctof %>% arrange(p.value,Value)
hist(gctof$Value,xlab = expression(paste(beta," Value")), 
     main = expression(paste("Histogram of ",beta," Values")))
hist(gctof$p.value,xlab = "P Value", main = "Histogram of P Values")
```

```{r echo=FALSE,cache=TRUE}
volcano <- ggplot(gctof,aes(x = Value, y = -log(p.value,base = 10))) +
  geom_point() + theme_bw() + ylab("-log10 p-value") + xlab("Estimate")
volcano
```

#### Number of Candidates by Cutoff

For this, I took a list of methylation-metabolite pairs significant at a given cutoff (columns), and counted how many of those methylation sites were significantly associated with T1D at another range of p value cutoffs (rows). Models of the association between methylation and T1D were adjusted for age and sex.

```{r echo=FALSE,cache=TRUE}
# Adjust p values
gctof$p.adj <- p.adjust(gctof$p.value, method = "fdr")
# Count number of pairs that are associated with methylation correlated with T1D
num_cand <- data.frame()
# Methylation < 0.05
num_cand[1,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
num_cand[1,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
num_cand[1,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
num_cand[1,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
# Methylation < 0.01
num_cand[2,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
num_cand[2,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
num_cand[2,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
num_cand[2,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
# Methylation < 0.001
num_cand[3,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
num_cand[3,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
num_cand[3,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
num_cand[3,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
# Methylation < 0.0001
num_cand[4,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
num_cand[4,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
num_cand[4,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
num_cand[4,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
# Row and column names
rownames(num_cand) <- c("< 0.05","< 0.01","< 0.001","< 0.0001")
kable(num_cand)
```

#### Top 10 (Sorted by P Value Then Estimate) 

```{r echo=FALSE}
gctof$p.value <- format(gctof$p.value,digits = 3)
gctof$p.adj <- format(gctof$p.adj,digits = 3)
kable(head(gctof,n=10),row.names = F)
```

### Undjusted Model

```{r eval=FALSE}
lm(cg00000029 ~ gctof_89, data = data)
```

#### Plots

```{r gctof unadj import,echo=FALSE,cache=TRUE}
gctof <- read.csv("/Users/timvigers/Documents/GitHub/MS-Thesis/candidate_selection/step_1/sv/gctof_SV_unadj.csv",stringsAsFactors = F)
gctof <- gctof %>% arrange(p.value,Value)
hist(gctof$Value,xlab = expression(paste(beta," Value")), 
     main = expression(paste("Histogram of ",beta," Values")))
hist(gctof$p.value,xlab = "P Value", main = "Histogram of P Values")
```

```{r echo=FALSE,cache=FALSE}
volcano <- ggplot(gctof,aes(x = Value, y = -log(p.value,base = 10))) +
  geom_point() + theme_bw() + ylab("-log10 p-value") + xlab("Estimate")
volcano
```

#### Number of Candidates by Cutoff

For this, I took a list of methylation-metabolite pairs significant at a given cutoff (columns), and counted how many of those methylation sites were significantly associated with T1D at another range of p value cutoffs (rows). Models of the association between methylation and T1D were adjusted for age and sex.

```{r echo=FALSE,cache=FALSE}
# Adjust p values
gctof$p.adj <- p.adjust(gctof$p.value, method = "fdr")
# Count number of pairs that are associated with methylation correlated with T1D
num_cand <- data.frame()
# Methylation < 0.05
num_cand[1,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
num_cand[1,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
num_cand[1,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
num_cand[1,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.05])
# Methylation < 0.01
num_cand[2,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
num_cand[2,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
num_cand[2,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
num_cand[2,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.01])
# Methylation < 0.001
num_cand[3,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
num_cand[3,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
num_cand[3,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
num_cand[3,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.001])
# Methylation < 0.0001
num_cand[4,"FDR < 0.05"] <- sum(gctof$methyl[gctof$p.adj < 0.05] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
num_cand[4,"p < 1e-2"] <- sum(gctof$methyl[gctof$p.value < 1e-2] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
num_cand[4,"p < 1e-3"] <- sum(gctof$methyl[gctof$p.value < 1e-3] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
num_cand[4,"p < 1e-4"] <- sum(gctof$methyl[gctof$p.value < 1e-4] %in% methyl_step2$methyl[methyl_step2$p.value < 0.0001])
# Row and column names
rownames(num_cand) <- c("< 0.05","< 0.01","< 0.001","< 0.0001")
kable(num_cand)
```

#### Top 10 (Sorted by P Value Then Estimate) 

```{r echo=FALSE}
gctof$p.value <- format(gctof$p.value,digits = 3)
gctof$p.adj <- format(gctof$p.adj,digits = 3)
kable(head(gctof,n=10),row.names = F)
```