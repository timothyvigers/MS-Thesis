---
title: "Triad Networks"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(bnlearn)
library(patchwork)
library(tidyverse)
```

```{r data import,echo=FALSE}
# Load list and data
load("/Users/timvigers/GitHub/MS-Thesis/data/networks/pair_list.Rdata")
load("/Users/timvigers/GitHub/MS-Thesis/data/networks/pair_data.Rdata")
pair_data$T1Dgroup = factor(pair_data$T1Dgroup)
```

```{r model structures,echo=FALSE}
# Define all network structures
# Empty graph
net = empty.graph(c("T1Dgroup","methyl","metab"))
# Structures
# 3 arcs
struct1 = "[T1Dgroup][methyl|T1Dgroup:metab][metab|T1Dgroup]"
struct2 = "[T1Dgroup][methyl|T1Dgroup][metab|T1Dgroup:methyl]"
struct3 = "[T1Dgroup|methyl:metab][methyl][metab|methyl]"
struct4 = "[T1Dgroup|methyl][methyl][metab|methyl:T1Dgroup]"
struct5 = "[T1Dgroup|metab:methyl][methyl|metab][metab]"
struct6 = "[T1Dgroup|metab][methyl|metab:T1Dgroup][metab]"
# 2 arcs
struct7 = "[T1Dgroup][methyl|T1Dgroup][metab|T1Dgroup]"
struct8 = "[T1Dgroup|methyl][methyl][metab|T1Dgroup]"
struct9 = "[T1Dgroup|metab][methyl|T1Dgroup][metab]"
struct10 = "[T1Dgroup|metab:methyl][methyl][metab]"
struct11 = "[T1Dgroup|methyl][methyl][metab|methyl]"
struct12 = "[T1Dgroup][methyl|T1Dgroup][metab|methyl]"
struct13 = "[T1Dgroup|methyl][methyl|metab][metab]"
struct14 = "[T1Dgroup][methyl|metab:T1Dgroup][metab]"
struct15 = "[T1Dgroup|metab][methyl|metab][metab]"
struct16 = "[T1Dgroup][methyl|metab][metab|T1Dgroup]"
struct17 = "[T1Dgroup|metab][methyl][metab|methyl]"
struct18 = "[T1Dgroup][methyl][metab|methyl:T1Dgroup]"
# 1 arc
struct19 = "[T1Dgroup][methyl|T1Dgroup][metab]"
struct20 = "[T1Dgroup][methyl][metab|T1Dgroup]"
struct21 = "[T1Dgroup|methyl][methyl][metab]"
struct22 = "[T1Dgroup][methyl][metab|methyl]"
struct23 = "[T1Dgroup|metab][methyl][metab]"
struct24 = "[T1Dgroup][methyl|metab][metab]"
```

```{r specific structures,echo=FALSE,message=FALSE,eval=FALSE}
# Make a list of every possible network structure (generic nodes)
all_nets = unlist(lapply(c(paste0("struct",1:24)), get))
# Iterate through pairs, and replace generic nodes with named ones
all_nets = apply(pairs,1,function(x){
  methyl = as.character(x["methyl"])
  metab = as.character(x["metab"])
  new_structs = gsub("methyl",methyl,all_nets)
  new_structs = gsub("metab",metab,new_structs)
  new_structs
})
```

## Hill Climbing

```{r hc,echo=FALSE}
# Find best model
best_nets = apply(pairs,1,function(x){
  methyl = as.character(x["methyl"])
  metab = as.character(x["metab"])
  temp = pair_data[,c("T1Dgroup",methyl,metab)]
  temp = temp[complete.cases(temp),]
  mod = hc(temp)
  mod
})
# Tabulate model types
arc_count = c()
types = c()
for(n in best_nets) {
  # Arc count
  arcs = as.data.frame(n$arcs,stringsAsFactors = F)
  arc_count = c(arc_count,nrow(arcs))
  # Rename arcs to general category
  arcs$from = sub("T1Dgroup","T1D",arcs$from)
  arcs$from = sub("cg.*","methyl",arcs$from)
  arcs$from = sub("ch.*","methyl",arcs$from)
  arcs$from = sub(".*_.*","metab",arcs$from)
  arcs$to = sub("T1Dgroup","T1D",arcs$to)
  arcs$to = sub("cg.*","methyl",arcs$to)
  arcs$to = sub("ch.*","methyl",arcs$to)
  arcs$to = sub(".*_.*","metab",arcs$to)
  # Get arcs
  arc1 = paste(arcs[1,1],"->",arcs[1,2])
  arc2 = paste(arcs[2,1],"->",arcs[2,2])
  arc3 = paste(arcs[3,1],"->",arcs[3,2])
  if (nrow(arcs) == 3) {
    all_arcs = c(arc1,arc2,arc3)
    all_arcs = all_arcs[order(all_arcs)]
    type = paste(all_arcs,collapse = ", ")
    types = c(types, type)
  } else if (nrow(arcs) == 2) {
    all_arcs = c(arc1,arc2)
    all_arcs = all_arcs[order(all_arcs)]
    type = paste(all_arcs,collapse = ", ")
    types = c(types, type)
  } else if (nrow(arcs) == 1) {
    types = c(types, arc1)
  }
}
tabs = as.data.frame(table(types))
```

```{r echo=FALSE}
n_struct1 = sum(types == "metab -> methyl, T1D -> metab, T1D -> methyl")
plot(model2network(struct1),main = paste0("n = ",n_struct1))
```