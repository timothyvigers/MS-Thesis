---
title: "MS Thesis Work"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,dpi = 600)
knitr::opts_knit$set(root.dir = "C:/Users/timbv/Documents/GitHub/MS-Thesis")
library(tidyverse)
library(patchwork)
library(DiagrammeR)
library(knitr)
library(bnlearn)
library(rjags)
```

```{r load datasets}
load("./data/networks/pair_data.Rdata")
load("./data/networks/cits.Rdata")
cits = cits[!(duplicated(cits[,c("methyl","metab")])),]
load("./data/networks/subset_mcmc_perms.Rdata")
subset_perms <- all_perms
load("./data/networks/all_mcmc_perms.Rdata")
load("./data/networks/pair_list.Rdata")
load("./data/networks/bnlearn_discretized.Rdata")
load("./data/networks/bnlearn_cit_discretized.Rdata")
load("./data/networks/all_mcmc_perms_methyl_scaled.Rdata")
load("./data/networks/subset_mcmc_perms_methyl_scaled.Rdata")
load("./data/networks/mcmc_sim_perms.Rdata")
load("./data/networks/mcmc_sim_perms_metab_scaled.Rdata")
load("./data/networks/mcmc_sim_perms_both_scaled.Rdata")
source("./code/networks/network_structures.R")
```

# Bayesian networks with JAGS

## Network structures and models

### Structure

```{r eval=FALSE}
ndf <-
  create_node_df(
    n = 3,
    label = c("Methylation","Metabolite","T1D Status"),
    shape = c("oval", "oval","oval"),
    fixedsize=F
  )
edf1 <-
  create_edge_df(
    from = c(2,1),
    to   = c(3,3),
    label = c("p < 0.05","p < 0.05")
  )
edf2 <-
  create_edge_df(
    from = 2,
    to   = 1,
    label = c("p < 0.001"),
    dir = "none"
  )
graph <-
  create_graph(
    nodes_df = ndf,
    edges_df = combine_edfs(edf1,edf2)
  )
graph %>% render_graph(layout = "kk",as_svg = T)
```

### Models

$$
\text{T1D | Metabolite} \sim \text{Bern}(\text{logit}(\alpha_0 + \alpha_1*\text{Metabolite}))\\
\text{Methylation | Metabolite, T1D} \sim \text{N}(\delta+\gamma*\text{Metabolite}+\beta*\text{T1D},\sigma^2)\\
$$

### Priors

$$
\alpha_0 \sim \text{N}(0,100)\\
\alpha_1 \sim \text{N}(0,100)\\
\delta \sim \text{N}(0,100)\\
\gamma \sim \text{N}(0,100)\\
\beta \sim \text{N}(0,100)\\
\sigma^2 = \frac{1}{\tau}\\
\tau \sim \text{Gamma}(0.0001,0.0001)
$$

```{r eval=FALSE}
# Plot all structures with DiagrammR
l <- lapply(paste0("struct",1:24), function(x){
  net <- model2network(get(x))
  d <- as.data.frame(net$arcs)
  d[d == "methyl"] <- 1
  d[d == "metab"] <- 2
  d[d == "T1Dgroup"] <- 3
  edf <- create_edge_df(from = c(d$from),to = d$to)
  graph <- 
    create_graph(
      nodes_df = ndf,
      edges_df = edf
    )
  return(graph)
})
l[[1]] %>% render_graph(layout = "kk",as_svg = T)
l[[2]] %>% render_graph(layout = "kk",as_svg = T)
l[[3]] %>% render_graph(layout = "kk",as_svg = T)
l[[4]] %>% render_graph(layout = "kk",as_svg = T)
l[[5]] %>% render_graph(layout = "kk",as_svg = T)
l[[6]] %>% render_graph(layout = "kk",as_svg = T)
l[[7]] %>% render_graph(layout = "kk",as_svg = T)
l[[8]] %>% render_graph(layout = "kk",as_svg = T)
l[[9]] %>% render_graph(layout = "kk",as_svg = T)
l[[10]] %>% render_graph(layout = "kk",as_svg = T)
l[[11]] %>% render_graph(layout = "kk",as_svg = T)
l[[12]] %>% render_graph(layout = "kk",as_svg = T)
l[[13]] %>% render_graph(layout = "kk",as_svg = T)
l[[14]] %>% render_graph(layout = "kk",as_svg = T)
l[[15]] %>% render_graph(layout = "kk",as_svg = T)
l[[16]] %>% render_graph(layout = "kk",as_svg = T)
l[[17]] %>% render_graph(layout = "kk",as_svg = T)
l[[18]] %>% render_graph(layout = "kk",as_svg = T)
l[[19]] %>% render_graph(layout = "kk",as_svg = T)
l[[20]] %>% render_graph(layout = "kk",as_svg = T)
l[[21]] %>% render_graph(layout = "kk",as_svg = T)
l[[22]] %>% render_graph(layout = "kk",as_svg = T)
l[[23]] %>% render_graph(layout = "kk",as_svg = T)
l[[24]] %>% render_graph(layout = "kk",as_svg = T)
```

```{r message=FALSE,fig.height=12,fig.width=14}
par(mar=c(1,1,1,1))
par(mfrow=c(6,4),lty="solid")
invisible(lapply(paste0("struct",1:24), function(x){
  m <- get(x)
  m <- gsub("methyl","Methylation",m)
  m <- gsub("metab","Metabolite",m)
  m <- gsub("T1Dgroup","T1D Status",m)
  net <- model2network(m)
  graphviz.plot(net,main = sub("struct","Structure ",x),
                shape = "ellipse")
}))
```

## Model comparisons

### DIC distribution by network structure

#### Cit-selected pairs - Unscaled

First, I looked at the distribution of DIC for all 139 methylation - metabolite pairs selected using the cit package. It appears that structures 14, 19, and 24 tend to be the best, all of which have one or two arrows pointing towards the methylation node. Interestingly, although structure 19 tended to have lower DIC when looking at all the pairs together, it was never selected as the best structure.

```{r}
all_dics <- sapply(all_perms,"[",1)
all_dics <- t(do.call(rbind,all_dics))
# Count best structures
kable(table(unlist(lapply(as.data.frame(all_dics), function(x){
  which.min(x)
}))),caption = "Number of Pairs Where Structure Is Best")
best <- lapply(as.data.frame(all_dics),function(x){
  min <- min(x)
  best <- which(x-min <=2)
  return(best)
})
kable(table(unlist(best)),caption = "Number of Pairs Where Structure Is Best or Within 2 DIC")
# Format DIC data
t = as.data.frame(t(all_dics))
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t[t$value<2000,],aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw() +
  ylim(-200,1200)
```

#### Cit-selected pairs - scaled methylation
 
Because the structures with arrows pointing towards methylation tended to have lower DIC, I repeated these tests with a scaled methylation variable. The idea was that perhaps methylation was "outweighing" the metabolites because only the metabolites were scaled. Scaling the methylation variables appears to reduce the variability in DIC, and results in structures 10, 21, and 23 being consistently the "best."

```{r}
all_dics <- sapply(all_perms_methyl_scaled,"[",1)
all_dics <- t(do.call(rbind,all_dics))
# Count best structures
kable(table(unlist(lapply(as.data.frame(all_dics), function(x){
  which.min(x)
}))),caption = "Number of Pairs Where Structure Is Best")
best <- lapply(as.data.frame(all_dics),function(x){
  min <- min(x)
  best <- which(x-min <=2)
  return(best)
})
kable(table(unlist(best)),caption = "Number of Pairs Where Structure Is Best or Within 2 DIC")
# Format DIC data
t = as.data.frame(t(all_dics))
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t[t$value<2000,],aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw() +
  ylim(-200,1200)
```

#### Non-cit pairs

Next, I selected metabolite - methylation pairs that were not associated with each other or with T1D status (p >= 0.5). I checked which structures were most often selected when there is no relationship between the three variables. The results look pretty similar to what we see with the selected pairs, which is somewhat concerning.

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t <- sapply(subset_perms,"[",1)
t <- do.call(rbind,t)
t = as.data.frame(t)
colnames(t) = paste0("struct",1:24)
# Count best structures
best <- apply(t,1,function(x){
  min <- min(x)
  best <- which(x-min <=2)
  return(best)
})
kable(table(unlist(lapply(as.data.frame(t(t)), function(x){
  which.min(x)
}))),caption = "Number of Pairs Where Structure Is Best")
kable(table(unlist(best)),caption = "Number of Pairs Where Structure Is Best or Within 2 DIC")
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw() +
  ylim(-200,1200)
```

#### Non-cit pairs - scaled methylation

Scaling methylation in the unrelated pairs has a similar effect to scaling the selected pairs.

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t <- sapply(subset_mcmc_perms_methyl_scaled,"[",1)
t <- do.call(rbind,t)
t = as.data.frame(t)
colnames(t) = paste0("struct",1:24)
# Count best structures
best <- apply(t,1,function(x){
  min <- min(x)
  best <- which(x-min <=2)
  return(best)
})
kable(table(unlist(lapply(as.data.frame(t(t)), function(x){
  which.min(x)
}))),caption = "Number of Pairs Where Structure Is Best")
kable(table(unlist(best)),caption = "Number of Pairs Where Structure Is Best or Within 2 DIC")
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw() +
  ylim(-200,1200)
```

### DIC simulations

Data were simulated for a single triad with nodes relating to each other according to network structure 1. 

#### "Correct" DIC for simulated struture 1

JAGS code was applied to the simulated data, and DIC results are below. Interestingly, we would fail to pick the correct network structure based on DIC, although it's possible we would select a similar 3 arc structure. However, the 2 arc structure 18 is significantly better than 4, and also has two arrows pointing towards the metabolite node.

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t = as.data.frame(rbind(mcmc_sim_perms[[1]]))
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw()
```

#### "Incorrect" permutations with simulated data for structure 1

The same permutation approach was applied to simulated data. For each permutation, the metabolite and methylation columns were sampled randomly without replacement, and DIC calculated using the permuted data. DIC appears to favor structures 10, 21, and 23 whene there is no real relationship between the three variables, which is interesting considering that we occasionally see these structures picked in our real data.

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t <- do.call(rbind,mcmc_sim_perms)
t = as.data.frame(t)
t = t[-c(1),]
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw()
```

#### "Correct" DIC for simulated struture 1, metabolite data scaled

Because some of the permutation testing suggests that scaling the data can affect DIC, the same simulations were run with the metabolomic data scaled to n(0,1), like our real data. There are some slight changes to DIC, but the overall pattern remains essentially the same (and we would still pick the wrong structure bases on DIC).

```{r,warning=FALSE}
# Get correct DICs (first permutation is with our data)
t = as.data.frame(rbind(mcmc_sim_perms_metab_scaled[[1]]))
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw()
```

#### "Incorrect" permutations with simulated data for structure 1, metabolite data scaled

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t <- do.call(rbind,mcmc_sim_perms_metab_scaled)
t = as.data.frame(t)
t = t[-c(1),]
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw()
```

#### "Correct" DIC for simulated struture 1, metabolite and methylation data scaled

I also simulated with both metabolite and methylation scaled, to see if that made a difference. Interestingly, the network we would select this way is close to correct, with two arrows pointing towards the methylation node. However, DIC is still not selecting the correct three arc network.

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t = as.data.frame(rbind(mcmc_sim_perms_both_scaled[[1]]))
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw()
```

#### "Incorrect" permutations with simulated data for structure 1, metabolite and methylation data scaled

With both variables scaled, we see the same pattern in the "incorrect" permutation tests.

```{r warning=FALSE}
# Get correct DICs (first permutation is with our data)
t <- do.call(rbind,mcmc_sim_perms_both_scaled)
t = as.data.frame(t)
t = t[-c(1),]
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw()
```

