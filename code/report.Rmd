---
title: "MS Thesis Work"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Documents/GitHub/MS-Thesis")
library(tidyverse)
library(patchwork)
library(DiagrammeR)
library(knitr)
library(bnlearn)
library(rjags)
```

```{r load datasets}
load("./data/networks/pair_data.Rdata")
load("./data/networks/all_dic.Rdata")
load("./data/networks/cits.Rdata")
load("./data/networks/subset_mcmc_perms.Rdata")
subset_perms <- all_perms
load("./data/networks/all_mcmc_perms.Rdata")
load("./data/networks/deal_best_models.Rdata")
source("./code/networks/network_structures.R")
```

# Bayesian networks with JAGS

## Network structures and models

### Structure

```{r warning=FALSE}
ndf <-
  create_node_df(
    n = 3,
    label = c("Methylation","Metabolite","T1D Status"),
    shape = c("oval", "oval","oval"),
    fixedsize=F
  )
edf1 <-
  create_edge_df(
    from = c(2,1),
    to   = c(3,3),
    label = c("p < 0.05","p < 0.05")
  )
edf2 <-
  create_edge_df(
    from = 2,
    to   = 1,
    label = c("p < 0.001"),
    dir = "none"
  )
graph <-
  create_graph(
    nodes_df = ndf,
    edges_df = combine_edfs(edf1,edf2)
  )
graph %>% render_graph(layout = "kk")
```

### Models

$$
\text{T1D | Metabolite} \sim \text{Bern}(\text{logit}(\alpha_0 + \alpha_1*\text{Metabolite}))\\
\text{Methylation | Metabolite, T1D} \sim \text{N}(\delta+\gamma*\text{Metabolite}+\beta*\text{T1D},\sigma^2)\\
$$

### Priors

$$
\alpha_0 \sim \text{N}(0,100)\\
\alpha_1 \sim \text{N}(0,100)\\
\delta \sim \text{N}(0,100)\\
\gamma \sim \text{N}(0,100)\\
\beta \sim \text{N}(0,100)\\
\sigma^2 = \frac{1}{\tau}\\
\tau \sim \text{Gamma}(0.0001,0.0001)
$$

```{r eval=FALSE}
# Plot all structures with DiagrammR
l <- lapply(paste0("struct",1:24), function(x){
  net <- model2network(get(x))
  d <- as.data.frame(net$arcs)
  d[d == "methyl"] <- 1
  d[d == "metab"] <- 2
  d[d == "T1Dgroup"] <- 3
  edf <- create_edge_df(from = c(d$from),to = d$to)
  graph <- 
    create_graph(
      nodes_df = ndf,
      edges_df = edf
    )
  return(graph)
})
l[[1]] %>% render_graph(layout = "kk",as_svg = T)
l[[2]] %>% render_graph(layout = "kk",as_svg = T)
l[[3]] %>% render_graph(layout = "kk",as_svg = T)
l[[4]] %>% render_graph(layout = "kk",as_svg = T)
l[[5]] %>% render_graph(layout = "kk",as_svg = T)
l[[6]] %>% render_graph(layout = "kk",as_svg = T)
l[[7]] %>% render_graph(layout = "kk",as_svg = T)
l[[8]] %>% render_graph(layout = "kk",as_svg = T)
l[[9]] %>% render_graph(layout = "kk",as_svg = T)
l[[10]] %>% render_graph(layout = "kk",as_svg = T)
l[[11]] %>% render_graph(layout = "kk",as_svg = T)
l[[12]] %>% render_graph(layout = "kk",as_svg = T)
l[[13]] %>% render_graph(layout = "kk",as_svg = T)
l[[14]] %>% render_graph(layout = "kk",as_svg = T)
l[[15]] %>% render_graph(layout = "kk",as_svg = T)
l[[16]] %>% render_graph(layout = "kk",as_svg = T)
l[[17]] %>% render_graph(layout = "kk",as_svg = T)
l[[18]] %>% render_graph(layout = "kk",as_svg = T)
l[[19]] %>% render_graph(layout = "kk",as_svg = T)
l[[20]] %>% render_graph(layout = "kk",as_svg = T)
l[[21]] %>% render_graph(layout = "kk",as_svg = T)
l[[22]] %>% render_graph(layout = "kk",as_svg = T)
l[[23]] %>% render_graph(layout = "kk",as_svg = T)
l[[24]] %>% render_graph(layout = "kk",as_svg = T)
```

```{r message=FALSE,fig.height=12,fig.width=14}
par(mar=c(1,1,1,1))
par(mfrow=c(6,4),lty="solid")
invisible(lapply(paste0("struct",1:24), function(x){
  m <- get(x)
  m <- gsub("methyl","Methylation",m)
  m <- gsub("metab","Metabolite",m)
  m <- gsub("T1Dgroup","T1D Status",m)
  net <- model2network(m)
  graphviz.plot(net,main = sub("struct","Structure ",x),
                shape = "ellipse")
}))
```

## Model comparisons

### DIC distribution by network structure

#### Candidates from cits package

```{r}
# Count best structures
kable(table(unlist(lapply(as.data.frame(all_dics), function(x){
  which.min(x)
}))),caption = "Number of Pairs Where Structure Is Best")
# Format DIC data
t = as.data.frame(t(all_dics))
colnames(t) = paste0("struct",1:24)
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(-250,1000)
```

#### Non-cits pairs

```{r}
# Get correct DICs (first permutation is with our data)
t <- sapply(subset_perms,"[",1)
t <- do.call(rbind,t)
t = as.data.frame(t)
colnames(t) = paste0("struct",1:24)
# Count best structures
kable(table(unlist(lapply(as.data.frame(t(t)), function(x){
  which.min(x)
}))),caption = "Number of Pairs Where Structure Is Best")
# Melt for plotting
t <- t %>% pivot_longer(struct1:struct24)
t$name = as.numeric(gsub("struct","",t$name))
# Plot
ggplot(t,aes(x=factor(name),y=value)) +
  geom_boxplot() +
  xlab("Structure number") + ylab("DIC") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylim(-250,1000)
```

### DIC differences

```{r}
l =
  lapply(colnames(all_dics), function(x){
    dics = all_dics[,x]
    pair = paste(cits[as.numeric(x),1],"-",cits[as.numeric(x),3])
    structs_1_2 = order(dics)[1:2]
    structs_2_3 = order(dics)[2:3]
    abs_diff_1_2 = diff(sort(dics)[1:2])
    abs_diff_2_3 = diff(sort(dics)[2:3])
    st = sd(dics)
    stand_diff_1_2 = abs_diff_1_2 / st
    stand_diff_2_3 = abs_diff_2_3 / st
    data.frame("Pair" = pair,
               "Abs.Diff.1.2" = abs_diff_1_2,"Std.Diff.1.2" = stand_diff_1_2,
               "Qual.Diff.1.2" =
                 all.equal(model2network(as.character(all_structs[structs_1_2[1]])),
                           model2network(as.character(all_structs[structs_1_2[2]]))),
               "Abs.Diff.2.3" = abs_diff_2_3,"Std.Diff.2.3" = stand_diff_2_3,
               "Qual.Diff.2.3" =
                 all.equal(model2network(as.character(all_structs[structs_2_3[1]])),
                           model2network(as.character(all_structs[structs_2_3[2]]))))
  })
dic_diff_table = do.call(rbind,l)
colnames(dic_diff_table) =
  c("Pair","Abs. Diff. Best-Second","Std. Diff. Best-Second",
    "Qual. Diff. Best-Second",
    "Abs. Diff. Second-Third","Std. Diff. Second-Third",
    "Qual. Diff. Second-Third")
# Print 1 - 2 and 2 - 3 differences
kable(dic_diff_table %>%
        pivot_longer(c(`Qual. Diff. Best-Second`,`Qual. Diff. Second-Third`)) %>%
        group_by(name, value) %>% count())
# Plot diff. distribution
diff_plot = dic_diff_table %>%
  pivot_longer(c(`Abs. Diff. Best-Second`,`Std. Diff. Best-Second`,
                 `Abs. Diff. Second-Third`,`Std. Diff. Second-Third`))
# Absolute
adp =
  ggplot(diff_plot[diff_plot$name %in% c("Abs. Diff. Best-Second",
                                         "Abs. Diff. Second-Third"),]) +
  theme_bw() + theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Absolute DIC Difference")
# Densities
adp +
  geom_density(aes(x = value,fill = name),alpha = 0.5) +
  theme(legend.title = element_blank())
# Boxplots
adp + geom_boxplot(aes(x = name,y = value,fill = name)) +
  theme(legend.position = "none") + xlab("")

# Standardized
adp =
  ggplot(diff_plot[diff_plot$name %in% c("Abs. Diff. Best-Second",
                                         "Abs. Diff. Second-Third"),]) +
  theme_bw() + theme(plot.title = element_text(hjust = 0.5)) +
  ggtitle("Absolute DIC Difference")

sdp =
  ggplot(diff_plot[diff_plot$name %in% c("Std. Diff. Best-Second",
                                         "Std. Diff. Second-Third"),]) +
  theme_bw() + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + ggtitle("Standardized DIC Difference")
# Densities
sdp +
  geom_density(aes(x = value,fill = name),alpha = 0.5) +
  theme(legend.title = element_blank())
# Boxplots
sdp + geom_boxplot(aes(x = name,y = value,fill = name)) +
  theme(legend.position = "none") + xlab("")
```

## Permutation tests

```{r,eval=FALSE}
l = lapply(all_perms, function(x){
  t = t(as.data.frame(x))
  t
})
```

## Potential problems

### DIC

- "From Bayesian perspective, DIC is not theoretically justified since it measures the fit of the model when the parameters are fixed to the posterior expectation and is not therefore an unbiased estimate of the true generalization utility." (Piironen & Vehtari, 2017)

- "The numerical experiments show that the over-fitting in the selection may be a potential problem and hinder the model selection considerably. This is the case especially when the dataset is small (high variance in the utility estimates) and the number of models under comparison large (large number of variables). Especially vulnerable methods for this type of overfitting are CV, WAIC, DIC and other methods that rely on data reuse and have therefore relatively high variance in the utility estimates." (Piironen & Vehtari, 2017)

### Priors

Tim was wrong about gamma priors causing problems. This issue is specific to logistic models with random effects, where the prior is $b_i \sim N(0,\frac{1}{\lambda})$. The Piironen paper can be a little unclear, so maybe we need a better resource.

# References

- Piironen, J., & Vehtari, A. (2017). Comparison of Bayesian predictive methods for model selection. Statistics and Computing, 27(3), 711â€“735. https://doi.org/10.1007/s11222-016-9649-y