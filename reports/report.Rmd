---
title: "MS Thesis: Mediation"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/GitHub/MS-Thesis")
library(patchwork)
library(DiagrammeR)
library(knitr)
library(ggplot2)
library(mediation)
```


```{r}
load("./data/mediation/methyl_psv_candidates.Rdata")
lipid_anno = read.csv("./data/raw_data/lipid.featureAnno.csv")
```

# Pair Selection

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Metabolite at SV']
  b[label= 'Methylation at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.001',fontsize = 9]
  a -- c [label = 'p< 0.05',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.05',fontsize = 9]}
  }
")
```

Using this mediation structure, there were `r nrow(methyl_psv_candidates)` pairs selected. The only metabolite selected was `r unique(methyl_psv_candidates[,2])`:

```{r}
kable(lipid_anno[lipid_anno$feature_name=="lipid_582",])
```

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Methylation at SV']
  b[label= 'Metabolite at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.001',fontsize = 9]
  a -- c [label = 'p< 0.05',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.05',fontsize = 9]}
  }
")
```

No pairs were selected using this mediation structure.

# Mediation Analysis

## Models

Terms:

$$
Y = \text{IA Status}\\
M = \text{Metabolite at SV}\\
T = \text{Methylation at PSV}\\
X_2 = \text{Age at PSV}\\
X_3 = \text{Sex}\\
X_4 = \text{DR3/4 Status}\\
\text{i indexes subject}\\
$$

### Mediator Model

$$
M_i = \beta_0 + \beta_1 T_i+\beta_2 X_{i2}+\beta_3 X_{i3}+\beta_4 X_{i4}+\epsilon_i\\
\text{With } \epsilon_i\text{ i.i.d. } N(0,\sigma^2)
$$

### Outcome Model

$$
\text{Let }p=\text{the probability a given subject is an IA case}=P(Y = 1)\\
ln(\frac{p}{1-p}) = \alpha_0 +\alpha_1 T_i+\alpha_2 M_i+\alpha_3 X_{i2}+\alpha_4 X_{i3}+\alpha_5 X_{i4}
$$

# Results

```{r message=FALSE}
# Import mediation results
load("./data/mediation/longitudinal_mediation_mods_100k.Rdata")
res = lapply(mediation_mods, function(m){
  s = summary(m)
  if(s$n.avg > 0.05 & s$n.avg.p < 0.05){return(s)}else{return(NA)}
})
names(res) = methyl_psv_candidates[,1]
res = res[!is.na(res)]
# Get probe annotation
load("./data/raw_data/annotation.450k.Rdata")
anno = as.data.frame(anno)
anno = anno[names(res),c("chr","pos","Relation_to_Island","UCSC_RefGene_Name",
                         "Enhancer","Regulatory_Feature_Group")]
```

Of the 19 candidate pairs, `r length(res)` had an average proportion mediated > 5% (statistically significant a nominal 0.05 level):

```{r}
kable(anno)
```

## cg00232387

![](/Users/timvigers/GitHub/MS-Thesis/images/cg00232387.png)

```{r}
res["cg00232387"]
```

## cg03052301

![](/Users/timvigers/GitHub/MS-Thesis/images/cg03052301.png)

```{r}
res["cg03052301"]
```

## cg03162492

![](/Users/timvigers/GitHub/MS-Thesis/images/cg03162492.png)

```{r}
res["cg03162492"]
```

## cg04442638

![](/Users/timvigers/GitHub/MS-Thesis/images/cg04442638.png)

```{r}
res["cg04442638"]
```

## cg05861255

![](/Users/timvigers/GitHub/MS-Thesis/images/cg05861255.png)

```{r}
res["cg05861255"]
```

## cg13536060

![](/Users/timvigers/GitHub/MS-Thesis/images/cg13536060.png)

```{r}
res["cg13536060"]
```

## cg14571710

![](/Users/timvigers/GitHub/MS-Thesis/images/cg14571710.png)

```{r}
res["cg14571710"]
```

## cg15342139

![](/Users/timvigers/GitHub/MS-Thesis/images/cg15342139.png)

```{r}
res["cg15342139"]
```

## cg16922753

![](/Users/timvigers/GitHub/MS-Thesis/images/cg16922753.png)

```{r}
res["cg16922753"]
```

## cg17202839

![](/Users/timvigers/GitHub/MS-Thesis/images/cg17202839.png)

```{r}
res["cg17202839"]
```

## cg19680388

![](/Users/timvigers/GitHub/MS-Thesis/images/cg19680388.png)

```{r}
res["cg19680388"]
```

## cg22598669

![](/Users/timvigers/GitHub/MS-Thesis/images/cg22598669.png)

```{r}
res["cg22598669"]
```

## cg23149053

![](/Users/timvigers/GitHub/MS-Thesis/images/cg23149053.png)

```{r}
res["cg23149053"]
```
