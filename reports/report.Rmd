---
title: "MS Thesis: Mediation"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Dropbox/School/MS Thesis")
library(patchwork)
library(DiagrammeR)
library(knitr)
library(tidyverse)
library(regmedint)
library(blandr)
```


```{r}
load("./data/mediation/methyl_psv_candidates_p_01.Rdata")
load("./data/mediation/metab_psv_candidates_p_01.Rdata")
lipid_anno = read.csv("./data/raw_data/lipid.featureAnno.csv")
```

# Pair Selection

To look for candidate metabolite-methylation pairs, I ran three linear models and selected based on the p value cutoffs below (e.g. metabolite and methylation associated at p < 0.01, and both associated with IA status at p < 0.01).

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Metabolite at SV']
  b[label= 'Methylation at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.01',fontsize = 9]
  a -- c [label = 'p< 0.01',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.01',fontsize = 9]}
  }
")
```

Using this mediation structure, there were `r nrow(methyl_psv_candidates)` pairs selected with `r length(unique(methyl_psv_candidates[,2]))` unique metabolites.

```{r}
kable(lipid_anno[lipid_anno$feature_name %in% unique(methyl_psv_candidates[,2]),])
```

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Methylation at SV']
  b[label= 'Metabolite at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.01',fontsize = 9]
  a -- c [label = 'p< 0.01',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.01',fontsize = 9]}
  }
")
```

Using this mediation structure, there were `r nrow(metab_psv_candidates)` pairs selected with `r length(unique(metab_psv_candidates[,2]))` unique metabolites.

```{r}
kable(lipid_anno[lipid_anno$feature_name %in% unique(metab_psv_candidates[,2]),])
```

Some of the hilic metabolites are lacking annotation information.

# Mediation Analysis

## Methylation at PSV

### Models

Terms:

$$
Y = \text{IA Status}\\
M = \text{Metabolite at SV}\\
T = \text{Methylation at PSV}\\
X_2 = \text{Sex}\\
X_3 = \text{DR3/4 Status}\\
X_4 = \text{Age at PSV}\\
X_5 = \text{Time from PSV to SV}\\
\text{i indexes subject}\\
$$

#### Mediator Model

$$
M_i = \beta_0 + \beta_1 T_i+\beta_2'C+\epsilon_i\\
\text{With } \epsilon_i\text{ i.i.d. } N(0,\sigma^2)
$$

In order to account for the case control design, the mediator model is fit to only the control subjects. The nature of case controls studies means that the cases are over-sampled compared to controls. The regression parameters in the outcome model are consistently estimated in logistic regression, but the study design needs to be taken into account in the mediator model. Fitting this model using only the controls is a good approximation for the regression coefficients that would be obtained in a cohort study, assuming the outcome is rare and that inclusion in the study depends only on the outcome (and not the mediator or exposure).

#### Outcome Model

$$
\text{Let }p=\text{the probability a given subject is an IA case}=P(Y = 1)\\
ln(\frac{p}{1-p}) = \theta_0 +\theta_1 T_i+\theta_2 M_i+\theta_3(T_i*M_i)+\theta_4'C
$$

Where $\beta_2'$ and $\theta_4'$ are vectors of estimates for multiple confounders $C$.

### Mediation

CDE is the controlled direct effect. This is how much the outcome would change on average if the mediator was fixed (at m) across the whole population, and the "treatment" (exposure) changed from 0 to 1. 

NDE is the natural direct effect. It represents the average change in outcome if the "exposure" changed from 0 to 1, and each individual's value for the mediator varied as it normally would (in the absence of the exposure). In other words, it is the effect of the exposure on the outcome that would remain if the path from exposure to mediator was removed. 

NIE is the natural indirect effect. It is the average change in outcome if the exposure was fixed at 1, but "the mediator were changed from the level it would take if $t^*=0$ to the level it would take if $t=1$." This is essentially the effect of the exposure on the outcome that operates through changing the mediator. 

If the interaction term is 0, both the CDE and NDE are equal to the direct effect under Baron and Kenny's formulation.

$$
OR^{CDE}(m)=exp(\theta_1+\theta_3 m)\\
OR^{NDE}=exp((\theta_1+\theta_3\beta_0+\theta_3\beta_1+\theta_3\beta_2'C+\theta_3\theta_2\sigma^2)+0.5\theta_3^2\sigma^2)\\
OR^{NIE}=exp(\theta_2\beta_1+\theta_3\beta_1)
$$

#### Results

```{r}
# Import package results
load("./data/mediation/long_med_p_05_psv_age_regmedint.Rdata")
psv_age_package_res = mediation_results
# Compare prop. mediated
manual = as.numeric(psv_age[,"PM"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"PM"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
```

The package and my code match perfectly.

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Lower CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"PM Lower"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"PM Lower"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Upper CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"PM Upper"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"PM Upper"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

### Indirect Effect

```{r}
# Compare prop. mediated
manual = as.numeric(psv_age[,"IE"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"IE"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
```

They match perfectly again!

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Lower CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"IE Lower"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"IE Lower"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Upper CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"IE Upper"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"IE Upper"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

The slope of this linear model is significantly different from 1 (p `r format.pval(p,eps = 0.001)`). A t test of the difference was also statistically significant (p = `r format.pval(t.test(package-manual)$p.value,eps = 0.001,digits = 3)`). 

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

### Direct Effect

```{r}
# Compare prop. mediated
manual = as.numeric(psv_age[,"DE"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"DE"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Lower CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"DE Lower"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"DE Lower"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Upper CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"DE Upper"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"DE Upper"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```
