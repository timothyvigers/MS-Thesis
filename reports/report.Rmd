---
title: "MS Thesis: Mediation"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Dropbox/School/MS Thesis")
library(patchwork)
library(DiagrammeR)
library(knitr)
library(tidyverse)
library(mediation)
library(blandr)
```


```{r}
load("./data/mediation/methyl_psv_candidates_p_01.Rdata")
lipid_anno = read.csv("./data/raw_data/lipid.featureAnno.csv")
```

# Pair Selection

To look for candidate metabolite-methylation pairs, I ran three linear models and selected based on the p value cutoffs below (e.g. metabolite and methylation associated at p < 0.01, and both associated with IA status at p < 0.01).

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Metabolite at SV']
  b[label= 'Methylation at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.01',fontsize = 9]
  a -- c [label = 'p< 0.01',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.01',fontsize = 9]}
  }
")
```

Using this mediation structure, there were `r nrow(methyl_psv_candidates)` pairs selected. The only metabolite selected was `r unique(methyl_psv_candidates[,2])`:

```{r}
kable(lipid_anno[lipid_anno$feature_name=="lipid_582",])
```

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Methylation at SV']
  b[label= 'Metabolite at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.01',fontsize = 9]
  a -- c [label = 'p< 0.01',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.01',fontsize = 9]}
  }
")
```

No pairs were selected using this mediation structure.

# Mediation Analysis

## Models

Terms:

$$
Y = \text{IA Status}\\
M = \text{Metabolite at SV}\\
T = \text{Methylation at PSV}\\
X_2 = \text{Age at PSV}\\
X_3 = \text{Sex}\\
X_4 = \text{DR3/4 Status}\\
\text{i indexes subject}\\
$$

### Mediator Model

$$
M_i = \beta_0 + \beta_1 T_i+\beta_2 X_{i2}+\beta_3 X_{i3}+\beta_4 X_{i4}+\epsilon_i\\
\text{With } \epsilon_i\text{ i.i.d. } N(0,\sigma^2)
$$

### Outcome Model

$$
\text{Let }p=\text{the probability a given subject is an IA case}=P(Y = 1)\\
ln(\frac{p}{1-p}) = \theta_0 +\theta_1 T_i+\theta_2 M_i+\theta_3 X_{i2}+\theta_4 X_{i3}+\theta_5 X_{i4}
$$

## Mediation

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Metabolite at SV']
  b[label= 'Methylation at PSV']
  c[label= 'IA']
  a -- b [label = 'a',fontsize = 9]
  a -- c [label = 'b',fontsize = 9]
  {rank = same;b -- c [label = 'c',fontsize = 9]}
  }
")
```

Given, the observed outcome $Y_i(T_i, M_i(T_i))$, where $M_i(T_i)$ represents the observed value of the mediator:

$$
\text{CME: }\\
\text{DE: }\\
\text{TE: }
$$



## `regmedint` package

### Proportion Mediated

```{r}
# Import package results
load("./data/mediation/long_med_p_05_psv_age_regmedint.Rdata")
psv_age_package_res = mediation_results
# Compare prop. mediated
manual = as.numeric(psv_age[,"PM"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"PM"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
```

The package and my code match perfectly.

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Lower CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"PM Lower"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"PM Lower"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Upper CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"PM Upper"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"PM Upper"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

### Indirect Effect

```{r}
# Compare prop. mediated
manual = as.numeric(psv_age[,"IE"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"IE"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
```

They match perfectly again!

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Lower CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"IE Lower"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"IE Lower"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Upper CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"IE Upper"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"IE Upper"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

The slope of this linear model is significantly different from 1 (p `r format.pval(p,eps = 0.001)`). A t test of the difference was also statistically significant (p = `r format.pval(t.test(package-manual)$p.value,eps = 0.001,digits = 3)`). 

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

### Direct Effect

```{r}
# Compare prop. mediated
manual = as.numeric(psv_age[,"DE"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"DE"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Lower CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"DE Lower"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"DE Lower"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```

#### Upper CI Bound

```{r}
# Compare prop. mediated LL
manual = as.numeric(psv_age[,"DE Upper"])
package = as.numeric(psv_age_package_res[match(psv_age[,"Probe"],psv_age_package_res[,"Probe"]),"DE Upper"])
# Plots
hist(package-manual)
plot(package,manual)
abline(coef = c(0,1))
# Linear model
sfit = summary(lm(package~manual))
kable(sfit$coefficients)
t = (sfit$coefficients[2,1]-1/sfit$coefficients[2,2])
p = 2 * pt(abs(t), df = 46, lower.tail = FALSE)
```

```{r warning=FALSE}
bland = blandr.statistics(package,manual)
blandr.draw(package,manual,annotate = T,ciDisplay = F) + theme_bw()
```
