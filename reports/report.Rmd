---
title: "MS Thesis: Mediation"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Documents/School/MS Thesis")
library(patchwork)
library(DiagrammeR)
library(knitr)
library(tidyverse)
library(mediation)
```


```{r}
load("./data/mediation/methyl_psv_candidates_p_05.Rdata")
lipid_anno = read.csv("./data/raw_data/lipid.featureAnno.csv")
```

# Pair Selection

To look for candidate metabolite-methylation pairs, I ran three linear models and selected based on the p value cutoffs below (e.g. metabolite and methylation associated at p < 0.001, and both associated with IA status at p < 0.05).

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Metabolite at SV']
  b[label= 'Methylation at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.001',fontsize = 9]
  a -- c [label = 'p< 0.05',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.05',fontsize = 9]}
  }
")
```

Using this mediation structure, there were `r nrow(methyl_psv_candidates)` pairs selected. The only metabolite selected was `r unique(methyl_psv_candidates[,2])`:

```{r}
kable(lipid_anno[lipid_anno$feature_name=="lipid_582",])
```

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Methylation at SV']
  b[label= 'Metabolite at PSV']
  c[label= 'IA']
  a -- b [label = 'p < 0.001',fontsize = 9]
  a -- c [label = 'p< 0.05',fontsize = 9]
  {rank = same;b -- c [label = 'p< 0.05',fontsize = 9]}
  }
")
```

No pairs were selected using this mediation structure.

# Mediation Analysis

## Models

Terms:

$$
Y = \text{IA Status}\\
M = \text{Metabolite at SV}\\
T = \text{Methylation at PSV}\\
X_2 = \text{Age at PSV}\\
X_3 = \text{Sex}\\
X_4 = \text{DR3/4 Status}\\
\text{i indexes subject}\\
$$

### Mediator Model

$$
M_i = \beta_0 + \beta_1 T_i+\beta_2 X_{i2}+\beta_3 X_{i3}+\beta_4 X_{i4}+\epsilon_i\\
\text{With } \epsilon_i\text{ i.i.d. } N(0,\sigma^2)
$$

### Outcome Model

$$
\text{Let }p=\text{the probability a given subject is an IA case}=P(Y = 1)\\
ln(\frac{p}{1-p}) = \theta_0 +\theta_1 T_i+\theta_2 M_i+\theta_3 X_{i2}+\theta_4 X_{i3}+\theta_5 X_{i4}
$$

## Mediation

```{r fig.height=8,fig.width=8}
grViz("
  graph{
  node [shape = box,fontname = Helvetica]
  a[label= 'Metabolite at SV']
  b[label= 'Methylation at PSV']
  c[label= 'IA']
  a -- b [label = 'a',fontsize = 9]
  a -- c [label = 'b',fontsize = 9]
  {rank = same;b -- c [label = 'c',fontsize = 9]}
  }
")
```

Given, the observed outcome $Y_i(T_i, M_i(T_i))$, where $M_i(T_i)$ represents the observed value of the mediator:

$$
\text{CME: }\delta_i(t)\equiv Y_i(t, M_i(1)) − Y_i(t, M_i(0))\\
\text{DE: } \gamma_i(t)\equiv Y_i(1, M_i(t)) − Y_i(0, M_i(t))\\
\text{TE: } \tau_i\equiv \delta_i(t)+\gamma_i(1−t)
$$

# Results

## Adjusting for age at PSV

```{r message=FALSE,cache=TRUE}
# Import mediation results
load("./data/mediation/long_med_p_05_psv_age_10k_sims.Rdata")
names(mediation_mods) = methyl_psv_candidates[,1]
res = lapply(names(mediation_mods), function(n){
  s = summary(mediation_mods[[n]])
  if((!is.na(s$n.avg) & s$n.avg > 0.2) & (!is.na(s$n.avg.p) & s$n.avg.p < 0.05)){
    ret = c(s$d.avg,s$d.avg.ci[1],s$d.avg.ci[2],s$z.avg,s$z.avg.ci[1],s$z.avg.ci[2],
            s$n.avg,s$n.avg.ci[1],s$n.avg.ci[2])
    return(c(n,"lipid_582",round(ret,5)))
  } else {
    return(NA)
  }
})
res = res[!is.na(res)]
res = do.call(rbind,res)
colnames(res) = c("Probe","Metabolite","DE","DE Lower","DE Upper",
                  "IE","IE Lower","IE Upper","PM","PM Lower","PM Upper")
```

```{r cache=TRUE}
kable(res)
# Get probe annotation
load("./data/raw_data/annotation.450k.Rdata")
anno = as.data.frame(anno)
anno = anno[names(res),c("chr","pos","Relation_to_Island","UCSC_RefGene_Name",
                         "Enhancer","Regulatory_Feature_Group")]
```

Of the `r nrow(methyl_psv_candidates)` candidate pairs, `r length(res)` had an average proportion mediated > 20% (statistically significant a nominal 0.05 level):

```{r}
kable(anno %>% arrange(as.numeric(sub("chr","",chr)),pos))
```

## Adjusting for Change in Age from PSV to SV

```{r message=FALSE,cache=TRUE}
# Import mediation results
load("./data/mediation/long_med_p_05_delta_age_10k_sims.Rdata")
names(mediation_mods) = methyl_psv_candidates[,1]
res = lapply(names(mediation_mods), function(n){
  s = summary(mediation_mods[[n]])
  if((!is.na(s$n.avg) & s$n.avg > 0.2) & (!is.na(s$n.avg.p) & s$n.avg.p < 0.05)){
    ret = c(s$d.avg,s$d.avg.ci[1],s$d.avg.ci[2],s$z.avg,s$z.avg.ci[1],s$z.avg.ci[2],
            s$n.avg,s$n.avg.ci[1],s$n.avg.ci[2])
    return(c(n,"lipid_582",round(ret,5)))
  } else {
    return(NA)
  }
})
res = res[!is.na(res)]
# res = do.call(rbind,res)
# colnames(res) = c("Probe","Metabolite","DE","DE Lower","DE Upper",
#                   "IE","IE Lower","IE Upper","PM","PM Lower","PM Upper")
```

```{r cache=TRUE}
#kable(res)
# Get probe annotation
load("./data/raw_data/annotation.450k.Rdata")
anno = as.data.frame(anno)
anno = anno[names(res),c("chr","pos","Relation_to_Island","UCSC_RefGene_Name",
                         "Enhancer","Regulatory_Feature_Group")]
```

Of the `r nrow(methyl_psv_candidates)` candidate pairs, `r length(res)` had an average proportion mediated > 20% (statistically significant a nominal 0.05 level):

```{r}
kable(anno %>% arrange(as.numeric(sub("chr","",chr)),pos))
```

# Network Approaches

# Future Directions and Questions

1. Perform a sensitivity analysis with manual mediation code 
- Per VanderWeele, "the case–control study design needs to be explicitly taken into account for the mediator regression" (pg. 28)
- IA is a rare outcome, so the case-control design oversamples the outcome.
- Do we know the incidence of IA status in the general population?
2. What else?
